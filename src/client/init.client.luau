-- è¿·è·¯ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆæ¨ªé•·ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒ‰å¯¾å¿œç‰ˆï¼‰
print("è¿·è·¯ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èµ·å‹•ä¸­...")

-- ã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
if not player.Character then
    player.CharacterAdded:Wait()
end

-- RemoteEventsã®å–å¾—
local remoteEvents = ReplicatedStorage:WaitForChild("RemoteEvents")
local startTimerEvent = remoteEvents:WaitForChild("StartTimer")
local stopTimerEvent = remoteEvents:WaitForChild("StopTimer")
local updateRankingEvent = remoteEvents:WaitForChild("UpdateRanking")

-- UIè¦ç´ 
local timerGui = nil
local timerLabel = nil
local resultGui = nil
local isTimerRunning = false
local startTime = 0

-- æ™‚é–“ã‚’æ–‡å­—åˆ—å½¢å¼ã«å¤‰æ›
local function formatTime(seconds)
    local minutes = math.floor(seconds / 60)
    local secs = seconds % 60
    return string.format("%02d:%05.2f", minutes, secs)
end

-- ã‚¿ã‚¤ãƒãƒ¼UIã®ä½œæˆ
local function createTimerUI()
    -- æ—¢å­˜ã®UIã‚’å‰Šé™¤
    if timerGui then
        timerGui:Destroy()
    end
    
    timerGui = Instance.new("ScreenGui")
    timerGui.Name = "MazeTimerGui"
    timerGui.Parent = playerGui
    
    -- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºãƒ•ãƒ¬ãƒ¼ãƒ 
    local timerFrame = Instance.new("Frame")
    timerFrame.Name = "TimerFrame"
    timerFrame.Size = UDim2.new(0, 200, 0, 80)
    timerFrame.Position = UDim2.new(0.5, -100, 0, 20)
    timerFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    timerFrame.BackgroundTransparency = 0.3
    timerFrame.BorderSizePixel = 0
    timerFrame.Parent = timerGui
    
    -- è§’ã‚’ä¸¸ãã™ã‚‹
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = timerFrame
    
    -- ã‚¿ã‚¤ãƒˆãƒ«ãƒ©ãƒ™ãƒ«
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TitleLabel"
    titleLabel.Size = UDim2.new(1, 0, 0.4, 0)
    titleLabel.Position = UDim2.new(0, 0, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = "MAZE TIMER"
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.TextScaled = true
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.Parent = timerFrame
    
    -- ã‚¿ã‚¤ãƒãƒ¼ãƒ©ãƒ™ãƒ«
    timerLabel = Instance.new("TextLabel")
    timerLabel.Name = "TimerLabel"
    timerLabel.Size = UDim2.new(1, 0, 0.6, 0)
    timerLabel.Position = UDim2.new(0, 0, 0.4, 0)
    timerLabel.BackgroundTransparency = 1
    timerLabel.Text = "00:00.00"
    timerLabel.TextColor3 = Color3.new(0, 1, 0)
    timerLabel.TextScaled = true
    timerLabel.Font = Enum.Font.Code
    timerLabel.Parent = timerFrame
    
    -- åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º
    timerFrame.Visible = false
end

-- çµæœè¡¨ç¤ºUIã®ä½œæˆ
local function createResultUI(completionTime, rank)
    -- æ—¢å­˜ã®çµæœUIã‚’å‰Šé™¤
    if resultGui then
        resultGui:Destroy()
    end
    
    resultGui = Instance.new("ScreenGui")
    resultGui.Name = "MazeResultGui"
    resultGui.Parent = playerGui
    
    -- èƒŒæ™¯ãƒ•ãƒ¬ãƒ¼ãƒ 
    local backgroundFrame = Instance.new("Frame")
    backgroundFrame.Name = "BackgroundFrame"
    backgroundFrame.Size = UDim2.new(1, 0, 1, 0)
    backgroundFrame.Position = UDim2.new(0, 0, 0, 0)
    backgroundFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    backgroundFrame.BackgroundTransparency = 0.5
    backgroundFrame.BorderSizePixel = 0
    backgroundFrame.Parent = resultGui
    
    -- çµæœè¡¨ç¤ºãƒ•ãƒ¬ãƒ¼ãƒ 
    local resultFrame = Instance.new("Frame")
    resultFrame.Name = "ResultFrame"
    resultFrame.Size = UDim2.new(0, 400, 0, 300)
    resultFrame.Position = UDim2.new(0.5, -200, 0.5, -150)
    resultFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    resultFrame.BorderSizePixel = 0
    resultFrame.Parent = backgroundFrame
    
    -- è§’ã‚’ä¸¸ãã™ã‚‹
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 15)
    corner.Parent = resultFrame
    
    -- å¢ƒç•Œç·š
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.new(1, 1, 0)
    stroke.Thickness = 3
    stroke.Parent = resultFrame
    
    -- å®Œäº†ãƒ†ã‚­ã‚¹ãƒˆ
    local completedLabel = Instance.new("TextLabel")
    completedLabel.Name = "CompletedLabel"
    completedLabel.Size = UDim2.new(1, 0, 0.3, 0)
    completedLabel.Position = UDim2.new(0, 0, 0, 0)
    completedLabel.BackgroundTransparency = 1
    completedLabel.Text = "ğŸ‰ MAZE COMPLETED! ğŸ‰"
    completedLabel.TextColor3 = Color3.new(1, 1, 0)
    completedLabel.TextScaled = true
    completedLabel.Font = Enum.Font.SourceSansBold
    completedLabel.Parent = resultFrame
    
    -- æ™‚é–“è¡¨ç¤º
    local timeLabel = Instance.new("TextLabel")
    timeLabel.Name = "TimeLabel"
    timeLabel.Size = UDim2.new(1, 0, 0.2, 0)
    timeLabel.Position = UDim2.new(0, 0, 0.3, 0)
    timeLabel.BackgroundTransparency = 1
    timeLabel.Text = "Time: " .. formatTime(completionTime)
    timeLabel.TextColor3 = Color3.new(0, 1, 0)
    timeLabel.TextScaled = true
    timeLabel.Font = Enum.Font.Code
    timeLabel.Parent = resultFrame
    
    -- é †ä½è¡¨ç¤º
    local rankLabel = Instance.new("TextLabel")
    rankLabel.Name = "RankLabel"
    rankLabel.Size = UDim2.new(1, 0, 0.2, 0)
    rankLabel.Position = UDim2.new(0, 0, 0.5, 0)
    rankLabel.BackgroundTransparency = 1
    rankLabel.Text = rank and ("Rank: #" .. rank) or "Rank: --"
    rankLabel.TextColor3 = Color3.new(1, 0.5, 0)
    rankLabel.TextScaled = true
    rankLabel.Font = Enum.Font.SourceSansBold
    rankLabel.Parent = resultFrame
    
    -- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0.6, 0, 0.15, 0)
    closeButton.Position = UDim2.new(0.2, 0, 0.8, 0)
    closeButton.BackgroundColor3 = Color3.new(0.2, 0.7, 0.2)
    closeButton.Text = "Continue"
    closeButton.TextColor3 = Color3.new(1, 1, 1)
    closeButton.TextScaled = true
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.Parent = resultFrame
    
    -- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®è§’ã‚’ä¸¸ãã™ã‚‹
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = closeButton
    
    -- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    closeButton.MouseButton1Click:Connect(function()
        resultGui:Destroy()
        resultGui = nil
    end)
    
    -- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
    resultFrame.Size = UDim2.new(0, 0, 0, 0)
    local tween = TweenService:Create(
        resultFrame,
        TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
        {Size = UDim2.new(0, 400, 0, 300)}
    )
    tween:Play()
end

-- æ¨ªé•·ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã®æ›´æ–°ï¼ˆæ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾å¿œï¼‰
local function updateRankingDisplay(rankings)
    -- ä¸¡æ–¹ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    local function updateSingleBoard(boardName)
        local rankingBoard = workspace.MazeGame:FindFirstChild(boardName)
        if not rankingBoard then return false end
        
        local rankingGui = rankingBoard:FindFirstChild("RankingGui")
        if not rankingGui then return false end
        
        local leftFrame = rankingGui:FindFirstChild("LeftFrame")
        local rightFrame = rankingGui:FindFirstChild("RightFrame")
        if not leftFrame or not rightFrame then return false end
        
        local leftScrollFrame = leftFrame:FindFirstChild("LeftScrollFrame")
        local rightScrollFrame = rightFrame:FindFirstChild("RightScrollFrame")
        if not leftScrollFrame or not rightScrollFrame then return false end
        
        -- å·¦å´ï¼ˆ1ä½-20ä½ï¼‰ã®æ›´æ–°
        for i = 1, 20 do
            local entry = leftScrollFrame:FindFirstChild("LeftEntry" .. i)
            if entry then
                local rankLabel = entry:FindFirstChild("RankLabel")
                local nameLabel = entry:FindFirstChild("NameLabel")
                local timeLabel = entry:FindFirstChild("TimeLabel")
                
                if rankLabel and nameLabel and timeLabel then
                    if rankings[i] then
                        nameLabel.Text = rankings[i].name
                        timeLabel.Text = formatTime(rankings[i].time)
                        
                        -- ãƒˆãƒƒãƒ—3ã®ç‰¹åˆ¥è¡¨ç¤º
                        if i <= 3 then
                            rankLabel.TextColor3 = Color3.new(1, 1, 0) -- é‡‘è‰²
                            nameLabel.TextColor3 = Color3.new(1, 1, 0.8)
                        else
                            rankLabel.TextColor3 = Color3.new(1, 1, 1) -- ç™½è‰²
                            nameLabel.TextColor3 = Color3.new(0.8, 0.8, 0.8)
                        end
                    else
                        nameLabel.Text = "---"
                        timeLabel.Text = "--:--"
                        rankLabel.TextColor3 = Color3.new(0.5, 0.5, 0.5)
                        nameLabel.TextColor3 = Color3.new(0.5, 0.5, 0.5)
                    end
                end
            end
        end
        
        -- å³å´ï¼ˆ21ä½-40ä½ï¼‰ã®æ›´æ–°
        for i = 21, 40 do
            local entry = rightScrollFrame:FindFirstChild("RightEntry" .. i)
            if entry then
                local rankLabel = entry:FindFirstChild("RankLabel")
                local nameLabel = entry:FindFirstChild("NameLabel")
                local timeLabel = entry:FindFirstChild("TimeLabel")
                
                if rankLabel and nameLabel and timeLabel then
                    if rankings[i] then
                        nameLabel.Text = rankings[i].name
                        timeLabel.Text = formatTime(rankings[i].time)
                        rankLabel.TextColor3 = Color3.new(0.9, 0.9, 0.9)
                        nameLabel.TextColor3 = Color3.new(0.7, 0.7, 0.7)
                    else
                        nameLabel.Text = "---"
                        timeLabel.Text = "--:--"
                        rankLabel.TextColor3 = Color3.new(0.5, 0.5, 0.5)
                        nameLabel.TextColor3 = Color3.new(0.5, 0.5, 0.5)
                    end
                end
            end
        end
        
        return true
    end
    
    -- ã‚´ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
    local goalBoardUpdated = updateSingleBoard("RankingBoard")
    
    -- ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
    local startBoardUpdated = updateSingleBoard("StartRankingBoard")
    
    local updatedCount = 0
    if goalBoardUpdated then updatedCount = updatedCount + 1 end
    if startBoardUpdated then updatedCount = updatedCount + 1 end
    
    print("ğŸ“Š ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆ" .. #rankings .. " ã‚¨ãƒ³ãƒˆãƒªã€" .. updatedCount .. " ãƒœãƒ¼ãƒ‰ï¼‰")
end

-- ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ãƒ«ãƒ¼ãƒ—
local timerConnection = nil

-- ã‚¹ã‚¿ãƒ¼ãƒˆã‚¿ã‚¤ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
startTimerEvent.OnClientEvent:Connect(function()
    isTimerRunning = true
    startTime = tick()
    
    -- ã‚¿ã‚¤ãƒãƒ¼UIã‚’è¡¨ç¤º
    if timerGui then
        timerGui.TimerFrame.Visible = true
    end
    
    -- ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
    if timerConnection then
        timerConnection:Disconnect()
    end
    
    timerConnection = RunService.Heartbeat:Connect(function()
        if isTimerRunning and timerLabel then
            local currentTime = tick() - startTime
            timerLabel.Text = formatTime(currentTime)
        end
    end)
    
    print("ğŸš€ ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹!")
end)

-- ã‚¹ãƒˆãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
stopTimerEvent.OnClientEvent:Connect(function(completionTime, rank)
    isTimerRunning = false
    
    -- ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢
    if timerConnection then
        timerConnection:Disconnect()
        timerConnection = nil
    end
    
    -- ã‚¿ã‚¤ãƒãƒ¼UIã‚’éè¡¨ç¤º
    if timerGui then
        timerGui.TimerFrame.Visible = false
    end
    
    -- çµæœUIã‚’è¡¨ç¤º
    createResultUI(completionTime, rank)
    
    print("ğŸ† ã‚´ãƒ¼ãƒ«! æ™‚é–“: " .. formatTime(completionTime) .. " é †ä½: " .. (rank or "ä¸æ˜"))
end)

-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ã‚¤ãƒ™ãƒ³ãƒˆ
updateRankingEvent.OnClientEvent:Connect(function(rankings)
    updateRankingDisplay(rankings)
end)

-- åˆæœŸåŒ–
local function initialize()
    createTimerUI()
    print("âœ… è¿·è·¯ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆUIåˆæœŸåŒ–å®Œäº†!")
    print("ğŸ“Š æ¨ªé•·ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒ‰å¯¾å¿œç‰ˆ")
end

-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèµ·å‹•æ™‚ã«åˆæœŸåŒ–
initialize()

print("âœ… è¿·è·¯ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ!")
