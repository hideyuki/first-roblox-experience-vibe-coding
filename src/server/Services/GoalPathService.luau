-- Kanata Maze ã‚´ãƒ¼ãƒ«ä¸€æœ¬é“ã‚µãƒ¼ãƒ“ã‚¹
local GoalPathService = {}

local workspace = game:GetService("Workspace")

-- ã‚´ãƒ¼ãƒ«ä¸€æœ¬é“åˆæœŸåŒ–ãƒ•ãƒ©ã‚°
local goalPathInitialized = false

-- å£ä½œæˆé–¢æ•°
local function createWall(position, size, name, parent)
    local wall = Instance.new("Part")
    wall.Name = name
    wall.Size = size
    wall.Position = position
    wall.Anchored = true
    wall.Material = Enum.Material.Brick
    wall.BrickColor = BrickColor.new("Dark stone grey")
    wall.Parent = parent
    return wall
end

-- ã‚¬ãƒ©ã‚¹å¤©äº•ä½œæˆé–¢æ•°
local function createGlassCeiling(position, size, parent)
    local ceiling = Instance.new("Part")
    ceiling.Name = "GoalPathCeiling"
    ceiling.Size = size
    ceiling.Position = position
    ceiling.Anchored = true
    ceiling.CanCollide = true
    ceiling.Material = Enum.Material.Glass
    ceiling.BrickColor = BrickColor.new("Institutional white")
    ceiling.Transparency = 0.1
    ceiling.Reflectance = 0.1
    ceiling.Parent = parent
    return ceiling
end

-- ä¸€æœ¬é“ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰
local function buildGoalPathSystem(mazeGame)
    -- å£ãƒ•ã‚©ãƒ«ãƒ€ã®å–å¾—
    local wallsFolder = mazeGame:FindFirstChild("Walls")
    if not wallsFolder then
        wallsFolder = Instance.new("Folder")
        wallsFolder.Name = "Walls"
        wallsFolder.Parent = mazeGame
    end
    
    -- æ—¢å­˜ã®å•é¡Œã®ã‚ã‚‹å£ã‚’å‰Šé™¤
    local problematicWalls = {
        "GoalGapWallLeft", "GoalGapWallRight",
        "GoalAreaExtendedWallLeft", "GoalAreaExtendedWallRight",
        "MazeBottomOuterWall", "GoalChannelWallLeft", "GoalChannelWallRight",
        "GoalPathWallLeft", "GoalPathWallRight"
    }
    
    for _, wallName in ipairs(problematicWalls) do
        local wall = wallsFolder:FindFirstChild(wallName)
        if wall then
            wall:Destroy()
        end
    end
    
    -- 1. è¿·è·¯çµ‚ç«¯ã‹ã‚‰ã‚´ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆã¾ã§ã®å°ç·šå£
    createWall(Vector3.new(-25, 20, 74), Vector3.new(6, 40, 4), "GoalChannelWallLeft", wallsFolder)
    createWall(Vector3.new(25, 20, 74), Vector3.new(6, 40, 4), "GoalChannelWallRight", wallsFolder)
    
    -- 2. ã‚´ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆã‹ã‚‰ã‚´ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã¾ã§ã®ä¸€æœ¬é“
    createWall(Vector3.new(-12, 20, 79), Vector3.new(6, 40, 12), "GoalPathWallLeft", wallsFolder)
    createWall(Vector3.new(12, 20, 79), Vector3.new(6, 40, 12), "GoalPathWallRight", wallsFolder)
    
    -- 3. ã‚´ãƒ¼ãƒ«ã‚¨ãƒªã‚¢å‘¨è¾ºã®å¤–å´å°é–
    createWall(Vector3.new(-45, 20, 115), Vector3.new(6, 40, 60), "GoalAreaLeftOuterWall", wallsFolder)
    createWall(Vector3.new(45, 20, 115), Vector3.new(6, 40, 60), "GoalAreaRightOuterWall", wallsFolder)
    createWall(Vector3.new(0, 20, 150), Vector3.new(96, 40, 6), "GoalAreaBackOuterWall", wallsFolder)
    
    -- 4. è¿·è·¯å¤–å´ã‹ã‚‰ã®è¿‚å›ã‚’é˜²ãè¿½åŠ å£
    createWall(Vector3.new(-95, 20, 40), Vector3.new(6, 40, 80), "MazeLeftSideWall", wallsFolder)
    createWall(Vector3.new(95, 20, 40), Vector3.new(6, 40, 80), "MazeRightSideWall", wallsFolder)
    createWall(Vector3.new(-60, 20, 80), Vector3.new(60, 40, 6), "MazeBottomWallLeft", wallsFolder)
    createWall(Vector3.new(60, 20, 80), Vector3.new(60, 40, 6), "MazeBottomWallRight", wallsFolder)
    
    print("ğŸ›¤ï¸ ã‚´ãƒ¼ãƒ«ä¸€æœ¬é“ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸ")
    
    -- 5. å¤©äº•ã®è¿½åŠ 
    local glassCeilingFolder = mazeGame:FindFirstChild("GlassCeiling")
    if glassCeilingFolder then
        for x = -20, 20, 10 do
            for z = 72, 84, 6 do
                createGlassCeiling(Vector3.new(x, 42, z), Vector3.new(10, 2, 6), glassCeilingFolder)
            end
        end
        print("ğŸ  ä¸€æœ¬é“å¤©äº•ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
    end
    
    -- 6. æ¡ˆå†…æ¨™è­˜å‰Šé™¤ï¼ˆè¦æ±‚ã«ã‚ˆã‚Šï¼‰
    print("ğŸ·ï¸ ã‚·ãƒ³ãƒ—ãƒ«ãªã‚´ãƒ¼ãƒ«ä¸€æœ¬é“ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸ")
end

-- ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–é–¢æ•°
function GoalPathService.Initialize()
    if goalPathInitialized then
        return
    end
    
    print("ğŸ›¤ï¸ ã‚´ãƒ¼ãƒ«ä¸€æœ¬é“ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ä¸­...")
    
    -- MazeGameã®å¾…æ©Ÿ
    local mazeGame = workspace:WaitForChild("MazeGame", 30)
    if not mazeGame then
        warn("âŒ MazeGameãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return
    end
    
    -- ä¸€æœ¬é“ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰
    buildGoalPathSystem(mazeGame)
    
    goalPathInitialized = true
    print("âœ… ã‚´ãƒ¼ãƒ«ä¸€æœ¬é“ã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–å®Œäº†ï¼")
end

-- ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹
function GoalPathService.Start()
    spawn(function()
        wait(5) -- ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã®å¾Œã«å®Ÿè¡Œ
        GoalPathService.Initialize()
    end)
end

return GoalPathService