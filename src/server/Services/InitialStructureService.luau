-- Kanata Maze åˆæœŸæ§‹é€ ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ­ãƒ¼ãƒ‰æ™‚å•é¡Œè§£æ±ºç‰ˆï¼‰
local InitialStructureService = {}

local workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")

-- åˆæœŸæ§‹é€ åˆæœŸåŒ–ãƒ•ãƒ©ã‚°
local initialStructureInitialized = false

-- åŸºæœ¬ç’°å¢ƒè¨­å®šã®å³åº§é©ç”¨
local function setupImmediateEnvironment()
    -- ç’°å¢ƒå…‰ã‚’å³åº§ã«è¨­å®š
    Lighting.Ambient = Color3.new(0.4, 0.4, 0.5)
    Lighting.Brightness = 2
    Lighting.OutdoorAmbient = Color3.new(0.6, 0.6, 0.7)
    Lighting.ColorShift_Bottom = Color3.new(0.3, 0.3, 0.4)
    Lighting.ColorShift_Top = Color3.new(0.8, 0.8, 0.9)
    Lighting.ShadowSoftness = 0.5
    Lighting.TimeOfDay = "14:00:00"
    Lighting.GeographicLatitude = 30
    
    print("â˜€ï¸ ç’°å¢ƒå…‰ã‚’å³åº§ã«è¨­å®šã—ã¾ã—ãŸ")
end

-- é‡è¦ãªåˆæœŸæ§‹é€ ã®äº‹å‰æ§‹ç¯‰
local function buildCriticalStructures(mazeGame)
    -- å£ä½œæˆé–¢æ•°
    local function createWall(position, size, name, parent)
        local wall = Instance.new("Part")
        wall.Name = name
        wall.Size = size
        wall.Position = position
        wall.Anchored = true
        wall.Material = Enum.Material.Brick
        wall.BrickColor = BrickColor.new("Dark stone grey")
        wall.Parent = parent
        return wall
    end
    
    -- å£ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆå³åº§ä½œæˆï¼‰
    local wallsFolder = Instance.new("Folder")
    wallsFolder.Name = "Walls"
    wallsFolder.Parent = mazeGame
    
    -- === ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢å‘¨è¾ºã®å®Œå…¨å°é– ===
    print("ğŸš§ ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢å‘¨è¾ºã‚’å®Œå…¨å°é–ä¸­...")
    
    -- ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®å®Œå…¨ãªå›²ã„ï¼ˆ40Ã—80ã®ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«å›²ã‚€ï¼‰
    -- ä¸Šå´ã®å£ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®å¥¥å´ã€z=-130ï¼‰
    createWall(Vector3.new(0, 20, -130), Vector3.new(86, 40, 6), "StartAreaBackWall", wallsFolder)
    
    -- å·¦å´ã®å£ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®å·¦å´ã€x=-43ï¼‰
    createWall(Vector3.new(-43, 20, -110), Vector3.new(6, 40, 46), "StartAreaLeftWall", wallsFolder)
    
    -- å³å´ã®å£ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã®å³å´ã€x=43ï¼‰
    createWall(Vector3.new(43, 20, -110), Vector3.new(6, 40, 46), "StartAreaRightWall", wallsFolder)
    
    -- ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã¾ã§ã®é€šè·¯ã®å·¦å´å£
    createWall(Vector3.new(-43, 20, -81.5), Vector3.new(6, 40, 17), "StartPassageLeftWall", wallsFolder)
    
    -- ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã¾ã§ã®é€šè·¯ã®å³å´å£
    createWall(Vector3.new(43, 20, -81.5), Vector3.new(6, 40, 17), "StartPassageRightWall", wallsFolder)
    
    -- è¿·è·¯å¤–å‘¨ã®é‡è¦éƒ¨åˆ†ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆå‘¨è¾ºï¼‰
    createWall(Vector3.new(-75, 20, -85), Vector3.new(50, 40, 6), "MazeTopWallLeft_Initial", wallsFolder)
    createWall(Vector3.new(75, 20, -85), Vector3.new(50, 40, 6), "MazeTopWallRight_Initial", wallsFolder)
    
    -- è¿·è·¯å·¦å³ã®å¤–å´å£ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆå‘¨è¾ºï¼‰
    createWall(Vector3.new(-95, 20, -50), Vector3.new(6, 40, 70), "MazeLeftWall_Initial", wallsFolder)
    createWall(Vector3.new(95, 20, -50), Vector3.new(6, 40, 70), "MazeRightWall_Initial", wallsFolder)
    
    print("âœ… ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢å‘¨è¾ºã®å³åº§å°é–å®Œäº†")
    
    -- === ã‚²ãƒ¼ãƒˆã®å³åº§é…ç½® ===
    print("ğŸšª ã‚²ãƒ¼ãƒˆã‚’å³åº§ã«é…ç½®ä¸­...")
    
    -- ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆ
    local startGate = Instance.new("Part")
    startGate.Name = "StartGate"
    startGate.Size = Vector3.new(6, 12, 1)
    startGate.Position = Vector3.new(0, 6, -73)
    startGate.Anchored = true
    startGate.CanCollide = false
    startGate.Material = Enum.Material.ForceField
    startGate.BrickColor = BrickColor.new("Bright green")
    startGate.Transparency = 0.7
    startGate.Parent = mazeGame
    
    -- ã‚´ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆ
    local goalGate = Instance.new("Part")
    goalGate.Name = "GoalGate"
    goalGate.Size = Vector3.new(6, 12, 1)
    goalGate.Position = Vector3.new(0, 6, 73)
    goalGate.Anchored = true
    goalGate.CanCollide = false
    goalGate.Material = Enum.Material.ForceField
    goalGate.BrickColor = BrickColor.new("Bright red")
    goalGate.Transparency = 0.7
    goalGate.Parent = mazeGame
    
    print("âœ… ã‚²ãƒ¼ãƒˆã‚’å³åº§ã«é…ç½®å®Œäº†")
    
    -- === åŸºæœ¬ã‚¬ãƒ©ã‚¹å¤©äº•ã®å³åº§é…ç½® ===
    print("ğŸ  åŸºæœ¬ã‚¬ãƒ©ã‚¹å¤©äº•ã‚’å³åº§ã«é…ç½®ä¸­...")
    
    local glassCeilingFolder = Instance.new("Folder")
    glassCeilingFolder.Name = "GlassCeiling"
    glassCeilingFolder.Parent = mazeGame
    
    -- é‡è¦ã‚¨ãƒªã‚¢ã®å¤©äº•ã‚’å³åº§ã«é…ç½®
    local criticalAreas = {
        {x1 = -80, x2 = 80, z1 = -90, z2 = -70},  -- ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢å‘¨è¾º
        {x1 = -30, x2 = 30, z1 = -75, z2 = 75},   -- ã‚²ãƒ¼ãƒˆå‘¨è¾º
        {x1 = -80, x2 = 80, z1 = 70, z2 = 90}     -- ã‚´ãƒ¼ãƒ«ã‚¨ãƒªã‚¢å‘¨è¾º
    }
    
    for _, area in ipairs(criticalAreas) do
        for x = area.x1, area.x2, 20 do
            for z = area.z1, area.z2, 20 do
                local ceiling = Instance.new("Part")
                ceiling.Name = "GlassCeiling_Initial"
                ceiling.Size = Vector3.new(20, 2, 20)
                ceiling.Position = Vector3.new(x, 42, z)
                ceiling.Anchored = true
                ceiling.CanCollide = true
                ceiling.Material = Enum.Material.Glass
                ceiling.BrickColor = BrickColor.new("Institutional white")
                ceiling.Transparency = 0.1
                ceiling.Reflectance = 0.1
                ceiling.Parent = glassCeilingFolder
            end
        end
    end
    
    print("âœ… åŸºæœ¬ã‚¬ãƒ©ã‚¹å¤©äº•ã‚’å³åº§ã«é…ç½®å®Œäº†")
    
    -- === åŸºæœ¬ç…§æ˜ã®å³åº§é…ç½® ===
    print("ğŸ’¡ åŸºæœ¬ç…§æ˜ã‚’å³åº§ã«é…ç½®ä¸­...")
    
    -- è¦‹ãˆãªã„ç’°å¢ƒå…‰æºã‚’å³åº§ã«é…ç½®
    for x = -60, 60, 30 do
        for z = -90, 90, 30 do
            local invisibleLight = Instance.new("Part")
            invisibleLight.Name = "InitialLight"
            invisibleLight.Size = Vector3.new(1, 1, 1)
            invisibleLight.Position = Vector3.new(x, 25, z)
            invisibleLight.Anchored = true
            invisibleLight.Transparency = 1
            invisibleLight.CanCollide = false
            invisibleLight.Parent = mazeGame
            
            local pointLight = Instance.new("PointLight")
            pointLight.Color = Color3.new(0.9, 0.9, 1)
            pointLight.Brightness = 2
            pointLight.Range = 35
            pointLight.Parent = invisibleLight
        end
    end
    
    print("âœ… åŸºæœ¬ç…§æ˜ã‚’å³åº§ã«é…ç½®å®Œäº†")
end

-- ãƒ¡ã‚¤ãƒ³åˆæœŸåŒ–é–¢æ•°
function InitialStructureService.Initialize()
    if initialStructureInitialized then
        return
    end
    
    print("ğŸ—ï¸ åˆæœŸæ§‹é€ ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆæœŸåŒ–ä¸­...")
    
    -- ç’°å¢ƒè¨­å®šã‚’å³åº§ã«é©ç”¨
    setupImmediateEnvironment()
    
    -- MazeGameãƒ•ã‚©ãƒ«ãƒ€ã®ç¢ºä¿
    local mazeGame = workspace:FindFirstChild("MazeGame")
    if not mazeGame then
        mazeGame = Instance.new("Folder")
        mazeGame.Name = "MazeGame"
        mazeGame.Parent = workspace
    end
    
    -- é‡è¦ãªæ§‹é€ ã‚’å³åº§ã«æ§‹ç¯‰
    buildCriticalStructures(mazeGame)
    
    initialStructureInitialized = true
    print("âœ… åˆæœŸæ§‹é€ ã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–å®Œäº†ï¼")
    print("ğŸš§ ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢éš™é–“å•é¡Œã‚’äº‹å‰ã«è§£æ±ºã—ã¾ã—ãŸ")
    print("ğŸ’¡ ç’°å¢ƒå…‰ã¨ã‚¬ãƒ©ã‚¹å¤©äº•ã‚’å³åº§ã«é©ç”¨ã—ã¾ã—ãŸ")
end

-- ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹ï¼ˆæœ€å„ªå…ˆã§å®Ÿè¡Œï¼‰
function InitialStructureService.Start()
    -- å³åº§ã«å®Ÿè¡Œï¼ˆé…å»¶ãªã—ï¼‰
    InitialStructureService.Initialize()
end

return InitialStructureService