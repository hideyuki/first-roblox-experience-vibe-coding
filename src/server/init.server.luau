-- è¿·è·¯ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ï¼ˆé‡è¤‡è¨˜éŒ²é˜²æ­¢ç‰ˆï¼‰
print("è¿·è·¯ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­...")

-- å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- åˆæœŸæ§‹é€ ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæœ€å„ªå…ˆï¼‰
local InitialStructureService = require(script.Services.InitialStructureService)

-- å…±æœ‰å®šæ•°ã®èª­ã¿è¾¼ã¿ï¼ˆsafe waitï¼‰
local function getConstants()
    local success, constants = pcall(function()
        return require(game.ReplicatedStorage:WaitForChild("Shared", 10):WaitForChild("Constants", 5))
    end)
    
    if success then
        return constants
    else
        warn("âŒ Constants.luauèª­ã¿è¾¼ã¿å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨: " .. tostring(constants))
        return {
            RANKING_DATASTORE_NAME = "KanataMazeRankings",
            RANKING_DATASTORE_KEY = "GlobalRankings20250604"
        }
    end
end

local Constants = getConstants()

-- ç…§æ˜ã‚µãƒ¼ãƒ“ã‚¹ã®èª­ã¿è¾¼ã¿
local LightingService = require(script.Services.LightingService)
local WarpService = require(script.Services.WarpService)
local WallService = require(script.Services.WallService)
local ComplexMazeService = require(script.Services.ComplexMazeService)
local GoalAreaService = require(script.Services.GoalAreaService)
local SignService = require(script.Services.SignService)
local GoalPathService = require(script.Services.GoalPathService)
local GoalLayoutService = require(script.Services.GoalLayoutService)
local CleanupService = require(script.Services.CleanupService)

-- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒã®æ¤œå‡º
local function isStudioLocalTest()
    return game:GetService("RunService"):IsStudio()
end

local isLocalTest = isStudioLocalTest()

-- DataStoreè¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
local rankingDataStore = nil
local RANKING_KEY = Constants.RANKING_DATASTORE_KEY

if not isLocalTest then
    local DataStoreService = game:GetService("DataStoreService")
    local success, result = pcall(function()
        return DataStoreService:GetDataStore(Constants.RANKING_DATASTORE_NAME)
    end)
    
    if success then
        rankingDataStore = result
        print("âœ… DataStoreæ¥ç¶šæˆåŠŸï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰")
        print("ğŸ“Š DataStoreå: " .. Constants.RANKING_DATASTORE_NAME)
        print("ğŸ”‘ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚­ãƒ¼: " .. Constants.RANKING_DATASTORE_KEY)
    else
        warn("âŒ DataStoreæ¥ç¶šå¤±æ•—: " .. tostring(result))
    end
else
    print("ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒ - DataStoreç„¡åŠ¹ã€ãƒ¡ãƒ¢ãƒªå†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä½¿ç”¨")
    print("ğŸ“Š æœ¬ç•ªç”¨DataStoreå: " .. Constants.RANKING_DATASTORE_NAME)
    print("ğŸ”‘ æœ¬ç•ªç”¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚­ãƒ¼: " .. Constants.RANKING_DATASTORE_KEY)
end

-- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ï¼ˆé‡è¤‡é˜²æ­¢å¼·åŒ–ï¼‰
local playerStates = {} -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ç®¡ç†
local globalRankings = {} -- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®å®šç¾©
local STATE = {
    WAITING = "WAITING",      -- å¾…æ©Ÿä¸­
    STARTED = "STARTED",      -- ã‚¹ã‚¿ãƒ¼ãƒˆæ¸ˆã¿ï¼ˆã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œä¸­ï¼‰
    COMPLETED = "COMPLETED"   -- ã‚´ãƒ¼ãƒ«æ¸ˆã¿ï¼ˆè¨˜éŒ²æ¸ˆã¿ï¼‰
}

-- RemoteEventsã®å®‰å…¨ãªå–å¾—
local function getRemoteEvents()
    local success, result = pcall(function()
        local remoteEvents = ReplicatedStorage:WaitForChild("RemoteEvents", 10)
        local startTimerEvent = remoteEvents:WaitForChild("StartTimer", 5)
        local stopTimerEvent = remoteEvents:WaitForChild("StopTimer", 5)
        local updateRankingEvent = remoteEvents:WaitForChild("UpdateRanking", 5)
        
        return {
            start = startTimerEvent,
            stop = stopTimerEvent,
            update = updateRankingEvent
        }
    end)
    
    if success then
        print("âœ… RemoteEventsã‚’æ­£å¸¸ã«å–å¾—ã—ã¾ã—ãŸ")
        return result
    else
        warn("âŒ RemoteEventsã®å–å¾—ã«å¤±æ•—: " .. tostring(result))
        return nil
    end
end

local remoteEvents = getRemoteEvents()
if not remoteEvents then
    warn("âŒ RemoteEventsãŒå–å¾—ã§ããªã„ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¾ã™")
    return
end

-- DataStoreã‹ã‚‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
local function loadRankings()
    if isLocalTest then
        -- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿
        globalRankings = {
            {name = "TestPlayer1", time = 45.23, timestamp = os.time()},
            {name = "TestPlayer2", time = 52.18, timestamp = os.time()},
            {name = "TestPlayer3", time = 63.45, timestamp = os.time()}
        }
        print("ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç”¨ãƒ€ãƒŸãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ")
        return
    end
    
    if not rankingDataStore then
        print("âš ï¸ DataStoreæœªæ¥ç¶š - æ–°ã—ã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’åˆæœŸåŒ–")
        globalRankings = {}
        return
    end
    
    local success, result = pcall(function()
        return rankingDataStore:GetAsync(RANKING_KEY)
    end)
    
    if success and result then
        globalRankings = result
        print("âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: " .. #globalRankings .. " ã‚¨ãƒ³ãƒˆãƒª")
    else
        globalRankings = {}
        print("ğŸ†• æ–°ã—ã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ")
    end
end

-- DataStoreã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆæœ¬ç•ªç’°å¢ƒã®ã¿ï¼‰
local function saveRankings()
    if isLocalTest then
        print("ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒ - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—")
        return
    end
    
    if not rankingDataStore then
        print("âš ï¸ DataStoreæœªæ¥ç¶š - ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—")
        return
    end
    
    local success, error = pcall(function()
        rankingDataStore:SetAsync(RANKING_KEY, globalRankings)
    end)
    
    if success then
        print("âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ")
    else
        warn("âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—: " .. tostring(error))
    end
end

-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ 
local function addToRankings(playerName, completionTime)
    -- æ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ 
    table.insert(globalRankings, {
        name = playerName,
        time = completionTime,
        timestamp = os.time()
    })
    
    -- æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆï¼ˆçŸ­ã„æ™‚é–“ãŒä¸Šä½ï¼‰
    table.sort(globalRankings, function(a, b)
        return a.time < b.time
    end)
    
    -- 100ä½ã¾ã§ã«åˆ¶é™
    if #globalRankings > 100 then
        for i = #globalRankings, 101, -1 do
            table.remove(globalRankings, i)
        end
    end
    
    -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é †ä½ã‚’è¦‹ã¤ã‘ã‚‹
    local playerRank = nil
    for i, entry in ipairs(globalRankings) do
        if entry.name == playerName and entry.time == completionTime then
            playerRank = i
            break
        end
    end
    
    return playerRank
end

-- æ™‚é–“ã‚’æ–‡å­—åˆ—å½¢å¼ã«å¤‰æ›
local function formatTime(seconds)
    local minutes = math.floor(seconds / 60)
    local secs = seconds % 60
    return string.format("%02d:%05.2f", minutes, secs)
end

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®åˆæœŸåŒ–
local function initializePlayerState(player)
    playerStates[player.UserId] = {
        state = STATE.WAITING,
        startTime = nil,
        player = player,
        lastGoalTime = 0  -- é‡è¤‡é˜²æ­¢ç”¨
    }
end

-- ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã®æ¤œå‡ºè¨­å®šï¼ˆé‡è¤‡é˜²æ­¢å¼·åŒ–ï¼‰
local function setupStartGate()
    local success, startGate = pcall(function()
        return workspace.MazeGame:WaitForChild("StartGate", 10)
    end)
    
    if not success or not startGate then
        warn("âŒ ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return
    end
    
    local function onTouched(hit)
        local humanoid = hit.Parent:FindFirstChild("Humanoid")
        if humanoid then
            local player = Players:GetPlayerFromCharacter(hit.Parent)
            if not player then return end
            
            -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®åˆæœŸåŒ–
            if not playerStates[player.UserId] then
                initializePlayerState(player)
            end
            
            local playerState = playerStates[player.UserId]
            
            -- WAITING çŠ¶æ…‹ã®æ™‚ã®ã¿ã‚¹ã‚¿ãƒ¼ãƒˆå¯èƒ½
            if playerState.state == STATE.WAITING then
                -- ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                playerState.state = STATE.STARTED
                playerState.startTime = tick()
                
                -- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥
                local success, error = pcall(function()
                    remoteEvents.start:FireClient(player)
                end)
                
                if success then
                    print("ğŸš€ " .. player.Name .. " ãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸ - ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹")
                else
                    warn("âŒ ã‚¹ã‚¿ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡å¤±æ•—: " .. tostring(error))
                end
            elseif playerState.state == STATE.STARTED then
                print("âš ï¸ " .. player.Name .. " ã¯æ—¢ã«ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œä¸­ã§ã™")
            elseif playerState.state == STATE.COMPLETED then
                -- COMPLETEDçŠ¶æ…‹ã®å ´åˆã¯å†æŒ‘æˆ¦ã¨ã—ã¦ WAITING ã«æˆ»ã™
                playerState.state = STATE.WAITING
                print("ğŸ”„ " .. player.Name .. " ãŒå†æŒ‘æˆ¦ã®ãŸã‚çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ")
            end
        end
    end
    
    startGate.Touched:Connect(onTouched)
    print("âœ… ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆé‡è¤‡é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ ä»˜ãï¼‰")
end

-- ã‚´ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆã®æ¤œå‡ºè¨­å®šï¼ˆé‡è¤‡é˜²æ­¢å¼·åŒ–ï¼‰
local function setupGoalGate()
    local success, goalGate = pcall(function()
        return workspace.MazeGame:WaitForChild("GoalGate", 10)
    end)
    
    if not success or not goalGate then
        warn("âŒ ã‚´ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return
    end
    
    local function onTouched(hit)
        local humanoid = hit.Parent:FindFirstChild("Humanoid")
        if humanoid then
            local player = Players:GetPlayerFromCharacter(hit.Parent)
            if not player then return end
            
            -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®ç¢ºèª
            if not playerStates[player.UserId] then
                print("âš ï¸ " .. player.Name .. " ã®çŠ¶æ…‹ãŒæœªåˆæœŸåŒ–ã§ã™")
                return
            end
            
            local playerState = playerStates[player.UserId]
            local currentTime = tick()
            
            -- STARTED çŠ¶æ…‹ã‹ã¤é‡è¤‡é˜²æ­¢ãƒã‚§ãƒƒã‚¯
            if playerState.state == STATE.STARTED and 
               (currentTime - playerState.lastGoalTime) > 2 then  -- 2ç§’é–“ã®é‡è¤‡é˜²æ­¢
                
                -- ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ãƒ»è¨˜éŒ²è¨ˆç®—
                local completionTime = currentTime - playerState.startTime
                local playerRank = addToRankings(player.Name, completionTime)
                
                -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°
                playerState.state = STATE.COMPLETED
                playerState.lastGoalTime = currentTime
                
                -- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«çµæœé€šçŸ¥
                local success1, error1 = pcall(function()
                    remoteEvents.stop:FireClient(player, completionTime, playerRank)
                end)
                
                -- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜
                saveRankings()
                
                -- å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°ã‚’é€šçŸ¥
                local success2, error2 = pcall(function()
                    remoteEvents.update:FireAllClients(globalRankings)
                end)
                
                if success1 and success2 then
                    print("ğŸ† " .. player.Name .. " ãŒã‚´ãƒ¼ãƒ«! æ™‚é–“: " .. formatTime(completionTime) .. " é †ä½: #" .. (playerRank or "ä¸æ˜"))
                else
                    warn("âŒ ã‚´ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡å¤±æ•—")
                    if not success1 then warn("  ã‚¹ãƒˆãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ: " .. tostring(error1)) end
                    if not success2 then warn("  ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°: " .. tostring(error2)) end
                end
            elseif playerState.state == STATE.WAITING then
                print("âš ï¸ " .. player.Name .. " ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã—ã¦ã„ã¾ã›ã‚“ï¼ˆã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã‚’é€šéã—ã¦ãã ã•ã„ï¼‰")
            elseif playerState.state == STATE.COMPLETED then
                print("â„¹ï¸ " .. player.Name .. " ã¯æ—¢ã«ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã§ã™ï¼ˆå†æŒ‘æˆ¦ã¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚²ãƒ¼ãƒˆã‹ã‚‰ï¼‰")
            elseif (currentTime - playerState.lastGoalTime) <= 2 then
                print("ğŸš« " .. player.Name .. " ã®é‡è¤‡è¨˜éŒ²ã‚’é˜²æ­¢ã—ã¾ã—ãŸ")
            end
        end
    end
    
    goalGate.Touched:Connect(onTouched)
    print("âœ… ã‚´ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆé‡è¤‡é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ ä»˜ãï¼‰")
end

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€€å‡ºæ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
local function onPlayerRemoving(player)
    if playerStates[player.UserId] then
        playerStates[player.UserId] = nil
        print("ğŸ§¹ " .. player.Name .. " ã®çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ")
    end
end

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ æ™‚ã®åˆæœŸåŒ–
local function onPlayerAdded(player)
    initializePlayerState(player)
    print("ğŸ‘‹ " .. player.Name .. " ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ")
end

-- åˆæœŸåŒ–
local function initialize()
    print("ğŸš€ è¿·è·¯ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã‚’åˆæœŸåŒ–ä¸­...")
    
    -- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    loadRankings()
    
    -- ã‚²ãƒ¼ãƒˆè¨­å®š
    setupStartGate()
    setupGoalGate()
    
    -- ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š
    Players.PlayerRemoving:Connect(onPlayerRemoving)
    Players.PlayerAdded:Connect(onPlayerAdded)
    
    -- æ—¢å­˜ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸåŒ–
    for _, player in pairs(Players:GetPlayers()) do
        initializePlayerState(player)
    end
    
    -- å®šæœŸçš„ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°ï¼ˆ5ç§’é–“éš”ï¼‰
    spawn(function()
        while true do
            wait(5)
            if remoteEvents and remoteEvents.update then
                local success, error = pcall(function()
                    remoteEvents.update:FireAllClients(globalRankings)
                end)
                if not success then
                    warn("å®šæœŸãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°å¤±æ•—: " .. tostring(error))
                end
            end
        end
    end)
    
    print("âœ… è¿·è·¯ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã®åˆæœŸåŒ–å®Œäº†!")
    print("ğŸ“Š ç¾åœ¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ•°: " .. #globalRankings .. " ã‚¨ãƒ³ãƒˆãƒª")
    print("ğŸ”’ é‡è¤‡è¨˜éŒ²é˜²æ­¢ã‚·ã‚¹ãƒ†ãƒ : æœ‰åŠ¹")
    print("ğŸ”„ çŠ¶æ…‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ : æœ‰åŠ¹")
    
    if isLocalTest then
        print("ğŸ® ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ - F5ã§ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤ã‚’é–‹å§‹ã—ã¦ãã ã•ã„")
    else
        print("ğŸŒ æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ - DataStoreé€£æºæœ‰åŠ¹")
    end
end

-- ãƒ¯ãƒ¼ãƒ—ã‚¾ãƒ¼ãƒ³ã®æ¤œå‡ºè¨­å®š
local function setupWarpZone()
    local success, warpZone = pcall(function()
        return workspace.MazeGame.WarpSystem:WaitForChild("WarpZone", 10)
    end)
    
    if not success or not warpZone then
        warn("âŒ ãƒ¯ãƒ¼ãƒ—ã‚¾ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆranking_and_warp_fix.luauã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰")
        return
    end
    
    local WARP_DESTINATION = Vector3.new(0, 5, -110) -- ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã¸ã®åº§æ¨™ï¼ˆåœ°é¢ã‚ˆã‚Šä¸Šï¼‰
    
    local function onWarpTouched(hit)
        local humanoid = hit.Parent:FindFirstChild("Humanoid")
        if humanoid then
            local player = Players:GetPlayerFromCharacter(hit.Parent)
            if not player then return end
            
            -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®ç¢ºèª
            if not playerStates[player.UserId] then
                initializePlayerState(player)
            end
            
            local playerState = playerStates[player.UserId]
            
            -- COMPLETEDçŠ¶æ…‹ã®ã¿ãƒ¯ãƒ¼ãƒ—å¯èƒ½ï¼ˆã‚´ãƒ¼ãƒ«å¾Œã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã¿ï¼‰
            if playerState.state == STATE.COMPLETED then
                -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒ¯ãƒ¼ãƒ—
                local character = player.Character
                if character and character:FindFirstChild("HumanoidRootPart") then
                    -- ãƒ¯ãƒ¼ãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå…‰ã‚‹æ¼”å‡ºï¼‰
                    local rootPart = character.HumanoidRootPart
                    
                    -- ãƒ¯ãƒ¼ãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
                    local attachment = Instance.new("Attachment")
                    attachment.Parent = rootPart
                    
                    local sparkles = Instance.new("Sparkles")
                    sparkles.Color = Color3.new(0, 1, 1)
                    sparkles.Parent = rootPart
                    
                    -- å®Ÿéš›ã®ãƒ†ãƒ¬ãƒãƒ¼ãƒˆ
                    rootPart.CFrame = CFrame.new(WARP_DESTINATION)
                    
                    -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã‚’WAITINGã«ãƒªã‚»ãƒƒãƒˆ
                    playerState.state = STATE.WAITING
                    playerState.startTime = nil
                    
                    -- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    spawn(function()
                        wait(2) -- 2ç§’é–“ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
                        if sparkles then sparkles:Destroy() end
                        if attachment then attachment:Destroy() end
                    end)
                    
                    print("ğŸŒ€ " .. player.Name .. " ãŒãƒ¯ãƒ¼ãƒ—ã‚¾ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã«æˆ»ã‚Šã¾ã—ãŸ")
                end
            elseif playerState.state == STATE.WAITING then
                print("â„¹ï¸ " .. player.Name .. " ã¯æ—¢ã«ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã«ã„ã¾ã™")
            elseif playerState.state == STATE.STARTED then
                print("âš ï¸ " .. player.Name .. " ã¯ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œä¸­ã§ã™ï¼ˆã‚´ãƒ¼ãƒ«å¾Œã«ãƒ¯ãƒ¼ãƒ—ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼‰")
            end
        end
    end
    
    warpZone.Touched:Connect(onWarpTouched)
    print("âœ… ãƒ¯ãƒ¼ãƒ—ã‚¾ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆã‚´ãƒ¼ãƒ«å¾Œã«ã‚¹ã‚¿ãƒ¼ãƒˆã‚¨ãƒªã‚¢ã¸ãƒ†ãƒ¬ãƒãƒ¼ãƒˆï¼‰")
end

-- åˆæœŸæ§‹é€ ã®å³åº§æ§‹ç¯‰ï¼ˆæœ€å„ªå…ˆã€é…å»¶ãªã—ï¼‰
InitialStructureService.Start()

-- ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«åˆæœŸåŒ–
initialize()

-- è¤‡é›‘è¿·è·¯ã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹ï¼ˆåˆæœŸæ§‹é€ ã®å¾Œã€ä»–ã‚ˆã‚Šå…ˆã«ï¼‰
ComplexMazeService.Start()

-- ã‚´ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®æ‹¡å¼µï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰
GoalAreaService.Start()

-- ã‚´ãƒ¼ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¿®æ­£
GoalLayoutService.Start()

-- ç…§æ˜ã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹
LightingService.Start()

-- ãƒ¯ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹
WarpService.Start()

-- å£ã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹ï¼ˆä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– - å…¥å£å•é¡Œä¿®æ­£ã®ãŸã‚ï¼‰
-- WallService.Start()

-- ã‚µã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹
SignService.Start()

-- ã‚´ãƒ¼ãƒ«ä¸€æœ¬é“ã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹
GoalPathService.Start()

-- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚·ã‚¹ãƒ†ãƒ ã®é–‹å§‹
CleanupService.Start()

-- ãƒ¯ãƒ¼ãƒ—ã‚¾ãƒ¼ãƒ³ã®è¨­å®šï¼ˆå°‘ã—é…å»¶ã•ã›ã¦MazeGameãŒå®Œå…¨ã«æ§‹ç¯‰ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
spawn(function()
    wait(6) -- 6ç§’å¾…æ©Ÿï¼ˆå…¨ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ã‚’å¾…ã¤ï¼‰
    setupWarpZone()
end)

print("âœ… è¿·è·¯ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ!")
print("ğŸ—ï¸ åˆæœŸæ§‹é€ å³åº§æ§‹ç¯‰å¯¾å¿œç‰ˆ")
print("ğŸŒŸ è¤‡é›‘è¿·è·¯è‡ªå‹•ç”Ÿæˆå¯¾å¿œç‰ˆ")
print("ğŸŒ€ ãƒ¯ãƒ¼ãƒ—ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œç‰ˆ")
print("ğŸªŸ è‡ªå‹•ã‚¬ãƒ©ã‚¹å¤©äº•ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œç‰ˆ")
print("ğŸ§± éš™é–“ä¿®æ­£å£ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œç‰ˆ")
print("ğŸ“Š åœ°é¢è¨­ç½®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒœãƒ¼ãƒ‰å¯¾å¿œç‰ˆ")
print("ğŸŸï¸ æ‹¡å¼µã‚´ãƒ¼ãƒ«ã‚¨ãƒªã‚¢å¯¾å¿œç‰ˆ")
print("ğŸ·ï¸ ã‚µã‚¤ãƒ³ä½ç½®ä¿®æ­£å¯¾å¿œç‰ˆ")
print("ğŸ›¤ï¸ ã‚´ãƒ¼ãƒ«ä¸€æœ¬é“ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œç‰ˆ")
print("ğŸ¨ ã‚´ãƒ¼ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–å¯¾å¿œç‰ˆ")
print("ğŸ§¹ ä¸è¦ã‚µã‚¤ãƒ³ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¯¾å¿œç‰ˆ")
